jQuery(document).ready(function(){
});

function createRegistryWindow(){
	$$ = jQuery;
	if($$('.registry-window').length > 0){
		console.log('Registry Window already opened');
	} else {
		var attrHTML = generate_select_boxes(attrJSON);
		generateRegistryWindow(attrHTML);
		var submitPressed = false;
		$$('.registry-window-submit').on('click', function(){
			if(!submitPressed){
				var selection = stringifySelections();
			
				var data = {
					action: 'add_registry_item',
					security : RegistryAjax.security,
					user_id: user_id,
					prod_id: prod_id,
					selection: selection
				};

				jQuery.post(RegistryAjax.ajaxurl, data, function(response) {
					console.log(response);
					//submitPressed = false;
				});
				submitPressed = true;
				console.log('Saving to DB');
			} else {
				console.log('Already Submitted');
			}
		});

		$$('.registry-window-close').on('click', function(){ $$('.registry-window').remove(); });
		$$('.registry-window-close').on('click', function(){ $$('.registry-create').remove(); });

		$$('.create-registry-submit').on('click', function(){
			$$('.registry-name-title').css('color', 'black');
			var registry_name = $$('.registry-name').val();
			var wedding_date = $$('.registry-date').val();
			var today = new Date();
			
			var data = {
				action: 'add_registry',
				security : RegistryAjax.security,
				user_id: user_id,
				registry_name: registry_name,
				wedding_date: wedding_date
			};
			
			if(wedding_date !== ""){
				$$('.registry-date-title').css('color', 'black');
				jQuery.post(RegistryAjax.ajaxurl, data, function(response) {
					if(response == 1){
						$$('.registry-name-title').css('color', 'red');
					} else{
						$$('.registry-create').remove();
						console.log('Registry Created');
					}
				});
			} else {
				$$('.registry-date-title').css('color', 'red');
			}
		});
	}
}

function generate_select_boxes(attr){
	var attributeHTML = '<div class="registry-window-right">';
	for (var key in attr) {
		attributeHTML += '<div class="prod-input">'+key+'<div class="registry-window-input">';
		var attrArr = attr[key].split(', ');
		attributeHTML += '<select id="'+key+'" class="registry-window-select">';
		for (var i = attrArr.length - 1; i >= 0; i--) {
			attributeHTML += '<option value="'+attrArr[i]+'">'+attrArr[i]+'</option>';
		}
		attributeHTML += '</select></div></div>';
	}
	attributeHTML += '<div class="prod-input registry-window-input-quantity">Quantity<div class="registry-window-input"><input class="registry-prod-quantity" type="number"></div></div>';
	return attributeHTML + '</div>';
}

function generateRegistryWindow(attrHTML){
	var prodImg = '<img src="'+prodImgSrc+'" height="250px" width="250px">';
	var registryWindowRight = attrHTML;
	var registry_window = '';
	if(!has_registry){
		registry_window += generateCreateRegistryWindow(dateRangeMin);
	}
	registry_window += '<div class="registry-window"><div class="registry-window-header">Add to Your Registry</div><div class="registry-window-close">X</div><div class="registry-window-body"><div class="registry-window-left">' + prodImg + '</div>' + registryWindowRight + '</div><div class="registry-window-footer"><span class="registry-window-submit">Submit</span></div></div>';
	
	$$('body').append(registry_window);

	$$('.registry-name').on('keydown', function(){
		var tenativeName = 'Jordan\'s Wedding';
		console.log(this.value());
		console.log(this.value);
		console.log(tenativeName);
		
	});
}

function generateCreateRegistryWindow(dateRangeMin){
	return '<div class="registry-create"><p class="registry-name-title">Registry Name</p><input placeholder="Name for your Registry" type="text" class="registry-windowcreate-input registry-name"><br><p class="registry-date-title">Registry Date</p><input type="date" class="registry-windowcreate-input registry-date" min="'+dateRangeMin+'"><br><div class="create-registry-submit">Create</div></div>';
}

function stringifySelections(){
	var selectedOptions = '';
	jQuery('.registry-window-select').each(function( index ){
		selectedOptions += this.id + ':' + this.options[this.selectedIndex].value + ',';
	});
	selectedOptions = selectedOptions.substring(0, selectedOptions.length-1);
	return selectedOptions;
}